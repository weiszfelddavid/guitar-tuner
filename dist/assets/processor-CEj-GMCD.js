(function(){"use strict";class p extends AudioWorkletProcessor{buffer;bufferIndex=0;framesSinceLastDetect=0;threshold=.1;BUFFER_SIZE=4096;PROCESSING_INTERVAL=256;constructor(f){super(),this.buffer=new Float32Array(this.BUFFER_SIZE),this.threshold=f?.processorOptions?.threshold||.1}process(f,h,n){const c=f[0];if(!c||!c.length)return!0;const a=c[0];for(let s=0;s<a.length;s++)this.buffer[this.bufferIndex]=a[s],this.bufferIndex=(this.bufferIndex+1)%this.BUFFER_SIZE,this.framesSinceLastDetect++,this.framesSinceLastDetect>=this.PROCESSING_INTERVAL&&(this.framesSinceLastDetect=0,this.detectPitch());return!0}detectPitch(){const f=this.BUFFER_SIZE/2,h=new Float32Array(f);let n=this.bufferIndex,c=0;for(let t=0;t<f;t++){const i=this.buffer[n];n=(n+1)%this.BUFFER_SIZE;const o=this.buffer[n];n=(n+1)%this.BUFFER_SIZE,h[t]=(i+o)/2,c+=i*i+o*o}const a=Math.sqrt(c/this.BUFFER_SIZE),s=f,e=new Float32Array(s/2);for(let t=0;t<s/2;t++){e[t]=0;for(let i=0;i<s/2;i++){const o=h[i]-h[i+t];e[t]+=o*o}}e[0]=1;let l=0;for(let t=1;t<s/2;t++)l+=e[t],e[t]*=t/l;let r=-1;for(let t=2;t<s/2;t++)if(e[t]<this.threshold){for(;t+1<s/2&&e[t+1]<e[t];)t++;r=t;break}if(r!==-1){let t=r;if(r>0&&r<s/2-1){const d=e[r-1],E=e[r],S=e[r+1];let u=(S-d)/(2*(2*E-S-d));u=Math.min(Math.max(u,-.5),.5),t+=u}const o=sampleRate/2/t;this.port.postMessage({pitch:o,clarity:1-e[r],bufferrms:a})}else this.port.postMessage({pitch:null,clarity:0,bufferrms:a})}}registerProcessor("pitch-processor",p)})();
